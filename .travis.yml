language: dart

dart:
  - stable
  - dev

env:
  global:
    - "HOST_IP=$(/sbin/ifconfig venet0:0 | grep 'inet addr' | awk -F: '{print $2}' | awk '{print $1}')"
    - SLIRP_HOST=$HOST_IP
    - DOCKER_HOST=tcp://$HOST_IP:2375
    - DOCKER_PORT_RANGE=2400:2500
#    - SLIRP_PORTS=$(seq 2375 2500)
  matrix:
    - PUB=DOWNGRADE
    - PUB=UPGRADE
#  - GOOGLE_CLOUD_DATASTORE_LOCAL_DEV_SERVER_EXECUTABLE=_install/google_cloud_datastore_dev_server/gcd-v1beta2-rev1-2.1.1/gcd.sh

script: dart -c tool/grind.dart travis

# Speed up builds by using containerization. Disable this if you need to use
# sudo in your scripts.
sudo: true

#branches:
#  only:
#    - master

cache:
  directories:
    - $HOME/.pub-cache

before_install:
  - sudo sh -c "wget -qO- https://get.docker.io/gpg | apt-key add -"
  - sudo sh -c "echo deb https://get.docker.io/ubuntu docker main > /etc/apt/sources.list.d/docker.list"
  - echo exit 101 | sudo tee /usr/sbin/policy-rc.d
  - sudo chmod +x /usr/sbin/policy-rc.d

install:
  - sudo apt-get update
  - sudo apt-get -y install lxc lxc-docker slirp
  - sudo sudo usermod -aG docker "$USER"
  - git clone git://github.com/cptactionhank/sekexe

before_script:
  - env
  - "sekexe/run 'mount -t tmpfs -o size=8g tmpfs /var/lib/docker && docker -d -H tcp://0.0.0.0:2375' &"
  #- "while ! docker info &> /dev/null ; do sleep 1; done"
  - "while ! docker info; do sleep 1; done"
  - echo done
  - docker pull google/cloud-sdk
  - mkdir $HOME/google-cloud-sdk/ platform/google_appengine
  - printf '#!/bin/sh\ndocker run --rm -v "$(pwd)":/app:rw google/gcloud-sdc gcloud "$@"' > $HOME/google-cloud-sdk/ platform/google_appengine/api_server.py
  - chmod ug+x   - chmod ug+x $HOME/google_cloud_datastore_dev_server/gcd-v1beta2-rev1-2.1.1/gcd.sh

  - docker pull zoechi/google-datastore-local-development-server
  - mkdir $HOME/google_cloud_datastore_dev_server/gcd-v1beta2-rev1-2.1.1
  - printf 'docker run --rm -v "$(pwd)":/app:rw zoechi/google-datastore-local-development-server gcd.sh "$@"' > $HOME/google_cloud_datastore_dev_server/gcd-v1beta2-rev1-2.1.1/gcd.sh
  - chmod ug+x $HOME/google_cloud_datastore_dev_server/gcd-v1beta2-rev1-2.1.1/gcd.sh
